<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<html>
    <head>


        <title>OpenSwells;</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {}
                }
            }
        </script>
        <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        

        body {
            font-family: 'JetBrains Mono', monospace !important;
        }
        </style>
    </head>


    <body class="h-screen w-screen relative dark:bg-slate-800">
        <script src='https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.js'></script>
        <link href='https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.css' rel='stylesheet' />

        <!-- 1) Wrap your map div inside #mapView so toggleView can hide/show it -->
        <div id="mapView" class="absolute inset-0 z-0">
            <div 
                          id="map"
                          class="absolute inset-0 z-0 h-screen w-screen" 
                          style="background: #ccc;"
                          >
                          <!-- Initialize map -->
            </div>
        </div>

        <!-- 2) Header "island" at the top -->
        <div class="header md:flex md:flex-row md:justify-evenly items-center p-2 absolute top-0 left-0 right-0 z-10 grid grid-cols-[1fr_auto] md:grid-cols-none gap-0.5 md:gap-0" >

          <!-- Logo -->
          <div class="title justify-self-start min-w-fit">
                <h1 class="md:text-xl text-l font-bold dark:text-white">
                    <a href="/" class="bg-white/95 dark:bg-slate-800/95 px-3 py-1">OpenSwells;</a>
                </h1>
            </div>

            <!-- Search -->
            <div class="searchbox md:w-1/2 col-start-1 col-span-2">
                <div id="search" class="search w-full dark:text-white col-span-2 md:col-span-1 row-start-2 md:row-start-1">
                    <input 
                     type="text" 
                     id="search" 
                     class="w-full border p-1 md:p-2 text-sm md:text-base dark:bg-slate-800 dark:text-white" 
                     placeholder="Search for a buoy"
                     >
                     <div id="searchResults" class="absolute z-50 w-full md:w-[calc(50%-1rem)] md:text-sm text-xs bg-white dark:bg-slate-800 max-h-[200px] overflow-y-auto mt-1 md:mt-2">
                     </div>
                </div>
            </div>

            <!-- Icons -->
            <div class="icons flex items-center row-start-1 col-start-2 gap-2.5 min-w-fit justify-self-end bg-white/95 dark:bg-slate-800/95">
                <a href="/about" class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center dark:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" fill="none" stroke="currentColor" 
                                                         width="20" height="20" class="md:w-6 md:h-6">
                        <path stroke-linecap="round" 
                              stroke-linejoin="round" 
                              stroke-width="2" 
                              d="M13 16h-1v-4h-1m1-4h.01
                                 M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </a>
                <a href="https://github.com/evancoons22/go-mb-surf" 
                   class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center dark:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" fill="currentColor"
                                             width="20" height="20" class="md:w-6 md:h-6">
                        <path d="M12 0C5.374 0 0 5.373 0 12c0
                                 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577
                                 v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756
                                 -1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237
                                 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604
                                 -2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221
                                 -.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.487
                                 11.487 0 0112 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23
                                 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221
                                 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293
                                 c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/>
                    </svg>
                </a>
                <a id="darkModeToggle" 
                   class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center cursor-pointer dark:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" fill="none" stroke="currentColor" 
                                                         width="20" height="20" class="md:w-6 md:h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" 
                                                     stroke-width="2" 
                                                     d="M12 3v1m0 16v1m9-9h-1
                                                        M4 12H3m15.364 6.364l-.707-.707
                                                        M6.343 6.343l-.707-.707m12.728 0l-.707.707
                                                        M6.343 17.657l-.707.707M16 12a4 4 0
                                                        11-8 0 4 4 0 018 0z" />
                    </svg>
                </a>
                <a href="#" id="signInBtn" class="login-link py-1 px-2 text-sm md:text-base dark:text-white">
                    Sign In
                </a>

                <!-- Sign-in Modal -->
                <div id="signInModal" 
                     class="fixed z-50 inset-0 bg-gray-600 bg-opacity-50 
                            flex items-start justify-center pt-[20vh] hidden">
                    <div class="signinmodal bg-white p-8 shadow-lg relative">
                        <button id="closeModal" 
                                class="absolute top-1 left-2 text-gray-500
                                       hover:text-gray-700 text-2xl font-bold">
                            &times;
                        </button>
                        <button onclick="googleSignIn()" 
                                class="bg-white hover:bg-gray-100 text-gray-800
                                       font-semibold py-2 px-4 border border-gray-400
                                       rounded shadow flex items-center">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" 
                                 alt="Google" class="mr-2" 
                                              style="width: 18px; height: 18px;">
                            Sign in with Google
                        </button>
                    </div>
                </div>

                <!-- User Popup -->
                <div id="userPopup" 
                     class="absolute right-3 mt-12 w-48 bg-white overflow-hidden shadow-xl z-10 hidden dark:bg-slate-800 dark:text-white">
                    <button id="closeUserPopup" 
                            class="absolute top-3 left-3 text-xl text-gray-500
                                   hover:text-gray-700 dark:text-white">
                        &times;
                    </button>
                    <div class="px-4 py-2 flex flex-col mt-8">
                        <p id="userName" class="text-sm font-medium text-gray-900 dark:text-white"></p>
                        <p id="userEmail" class="text-sm font-medium text-gray-500 dark:text-white"></p>
                    </div>
                    <a href="#" id="signOutBtn" 
                                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-white">
                        Sign out
                    </a>
                </div>
            </div>
        </div>
        <!-- End Header -->


        <!-- 3) Toggle Buttons -->
        <div class="absolute md:top-[4rem] top-[4.6rem] md:left-4 left-2 flex gap-2" >
            <button id="showMapBtn" 
                    class="md:w-24 w-20 md:py-1 py-0.5 px-3 text-xs md:text-sm border font-bold border-2 border-black dark:border-white text-black bg-white dark:bg-slate-800 dark:text-white rounded flex items-center justify-center"
                    onclick="toggleView('map')" >
                    Map
            </button>
            <button id="showFavoritesBtn" 
                    class="md:w-24 w-20 md:py-1 py-0.5 px-3 text-xs md:text-sm border text-black border-black dark:border-white bg-white dark:bg-slate-800 dark:text-white rounded flex items-center justify-center"
                    onclick="toggleView('favorites')" >
                    Favorites
            </button>
        </div>


            <!-- 4) Favorites Section (main content area when active) -->
            <div 
                                id="favoritesView" 
                                class="absolute top-[7rem] bottom-0 left-0 right-0 hidden z-10 px-4 w-full dark:bg-slate-800"
                                >
                                <div 
                                id="buoy-containers" 
                                class="favorites w-full h-full max-w-[90vw] mx-auto 
                                       overflow-auto bg-white dark:bg-slate-800"
                                >
                                <!-- Favorites content goes here -->
                                </div>
            </div>


            <!-- Legend -->
            <div class="legend absolute lg:bottom-40 bottom-72 left-4 z-10 bg-white/95 dark:bg-slate-800/95 p-3 shadow-lg hidden lg:block">
                <!-- <div class="legend absolute lg:bottom-40 bottom-72 left-4 z-10 bg-white/95 dark:bg-slate-800/95 p-3 shadow-lg"> --> 
                <div class="text-xs font-semibold mb-2 dark:text-white">(m)</div>
                <div class="flex flex-col gap-1">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-4" style="background-color: #A50026;"></div>
                        <span class="text-xs dark:text-white">10.0+</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-4" style="background-color: #D73027;"></div>
                        <span class="text-xs dark:text-white">8.0</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-4" style="background-color: #F46D43;"></div>
                        <span class="text-xs dark:text-white">6.0</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-4" style="background-color: #74ADD1;"></div>
                        <span class="text-xs dark:text-white">4.0</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-4" style="background-color: #4575B4;"></div>
                        <span class="text-xs dark:text-white">2.0</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-4" style="background-color: #ADD8E6;"></div>
                        <span class="text-xs dark:text-white">&lt; 2.0</span>
                    </div>
                </div>
            </div>

            <!-- 5) Bottom Controls (overlay at bottom) -->
            <div class="bottom-controls absolute bottom-0 left-0 right-0 grid lg:grid-cols-3 grid-cols-1 items-end lg:gap-4 gap-1 m-4 z-10 lg:mb-4 mb-14">
                <!-- Report Container - Left -->
                <div id="report-container" class="report w-auto max-w-[600px] bg-white/95 dark:bg-gray-800/95 shadow-lg lg:col-start-1 ">
                    <div class="buoy-name border-b border-black dark:border-white dark:bg-slate-800 dark:text-white p-2 flex justify-between items-center">
                        <div id="report-title" class="report-title text-sm truncate max-w-[70%]">
                            Choose buoy
                        </div>
                        <div>
                            <button id="forecastBtn" class="forecast border border-blue-900 dark:border-blue-400 text-blue-900 dark:text-blue-400 px-2 py-0.5 text-xs hover:bg-blue-50 dark:hover:bg-blue-900/30">
                                Forecast
                            </button>
                        </div>
                    </div>
                    <div id="report-content" class="p-2 dark:bg-slate-800 dark:text-white">
                        {{template "report_small" .}}
                    </div>
                </div>

                <!-- Metadata Container - Center -->
                <div class="bg-white/95 dark:bg-slate-800/95 p-2 shadow-lg flex items-center gap-2  min-w-[100px] justify-self-center w-full lg:w-auto">
                    <span class="text-xs font-semibold dark:text-white">Last Updated:</span>
                    <span id="metadataTimestamp" class="text-xs dark:text-white"></span>
                </div>

                <!-- Time Slider Container - Right -->
                <div class="bg-white/95 dark:bg-slate-800/95 p-2 shadow-lg flex items-center gap-2 dark:text-white lg:w-auto lg:justify-self-end">
                    <button id="playButton" class="w-12 h-12 flex items-center justify-center rounded hover:bg-gray-200 dark:hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </button>
                    <div class="flex flex-col w-full">
                        <div class="flex items-center gap-2">
                            <input type="range" 
                                   id="timeSlider" 
                                   min="0" 
                                   max="384" 
                                   value="0" 
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600">
                            <span id="timeValue" class="text-xs min-w-[4em]">+000 hrs</span>
                        </div>
                        <span id="forecastTime" class="text-xs dark:text-gray-200 mt-1"></span>
                    </div>
                </div>
            </div>

            


            <script>
                function toggleView(view) {
                    const mapView = document.getElementById('mapView');
                    const favoritesView = document.getElementById('favoritesView');
                    const mapBtn = document.getElementById('showMapBtn');
                    const favBtn = document.getElementById('showFavoritesBtn');
                    const search = document.getElementById('search');

                    // The single bottom-controls container
                    const bottomControls = document.querySelector('.bottom-controls');
                    const legend = document.querySelector('.legend');

                    if (view === 'map') {
                        // Show map
                        mapView.classList.remove('hidden');
                        favoritesView.classList.add('hidden');

                        // search
                        search.classList.remove('hidden');

                        // Show bottom controls
                        bottomControls.classList.remove('hidden');
                        // hide / show legend
                        legend.classList.add('lg:block');

                        // Update button states
                        mapBtn.classList.add('font-bold','border-2');
                        favBtn.classList.remove('font-bold', 'border-2');
                    } else {
                        // Show favorites
                        mapView.classList.add('hidden');
                        favoritesView.classList.remove('hidden');

                        //search
                        search.classList.add('hidden');

                        // Hide bottom controls
                        bottomControls.classList.add('hidden');
                        legend.classList.remove('lg:block');

                        // Update button states
                        favBtn.classList.add('font-bold', 'border-2');
                        mapBtn.classList.remove('font-bold', 'border-2');
                    }
                }

            </script> 

    </body>


        <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

        <!-- firebase sign in script --> 
        <script type="module">
            // Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyBKZUgrKoU8MxXIm9H0mGubjfL8TANdH5g",
          authDomain: "open-swells-89714.firebaseapp.com",
          projectId: "open-swells-89714",
          storageBucket: "open-swells-89714.appspot.com",
          messagingSenderId: "764680526760",
          appId: "1:764680526760:web:77bf8034f0f8df259b1b9d",
          measurementId: "G-BJTLM29FYZ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        firebase.auth().onAuthStateChanged(updateUIForSignedInUser);

        </script>
        <script> 
            let userBuoys = [];
            const popupMap = new Map(); // Use a Map to store popups by their ID
            async function loadForecastSummary(uid) {
                try {
                    const summaryResponse = await fetch(`/forecast-summary?uid=${encodeURIComponent(uid)}`);

                    if (!summaryResponse.ok) {
                        console.log("Error: Could not load forecast summary");
                        throw new Error('Failed to load forecast summary');
                    }

                    const html = await summaryResponse.text();
                    document.getElementById('buoy-containers').innerHTML = html;

                } catch (error) {
                    console.error('Error loading forecast summary:', error);
                    document.getElementById('buoy-containers').innerHTML =
                        '<p>Failed to load forecast summary. Please try again later.</p>';
                }
            }

            async function loadUserBuoys(uid) {
                try {
                    const userBuoysResponse = await fetch(`/get-user-buoys?uid=${encodeURIComponent(uid)}`);

                    if (!userBuoysResponse.ok) {
                        console.log("Error: Could not load user buoys");
                        throw new Error('Failed to load user buoys');
                    }

                    userBuoys = await userBuoysResponse.json();
                    userBuoys = userBuoys.buoys || [];

                    console.log('User buoys:', userBuoys);
                } catch (error) {
                    console.error('Error loading user buoys:', error);
                    userBuoys = [];
                }
            }
            // Wait for Firebase authentication
            document.addEventListener('DOMContentLoaded', () => {
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        await loadForecastSummary(user.uid);
                        await loadUserBuoys(user.uid);
                        // Update all popup contents after loading user buoys
                    } else {
                        console.log('User not signed in.');
                        document.getElementById('buoy-containers').innerHTML =
                            '<p class="dark:text-white">Please sign in to view your favorite buoys.</p>';
                    }
                });
            });

            function googleSignIn() {
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider)
                    .then(result => {
                        updateUIForSignedInUser(result.user);
                    })
                    .catch(error => console.error('Sign-in error:', error));
            }

            function updateUIForSignedInUser(user) {
                const signInBtn = document.getElementById('signInBtn');
                if (user) {
                    // User is signed in
                    signInBtn.innerHTML = `<img src="${user.photoURL}" alt="Profile" class="md:w-8 md:h-8 w-6 h-6 rounded-full">`;
                    // signInBtn.onclick = () => firebase.auth().signOut().then(() => updateUIForSignedInUser(null));
                    signInBtn.onclick = () => document.getElementById('userPopup').classList.remove('hidden');
                    document.getElementById('userName').textContent = user.displayName;
                    document.getElementById('userEmail').textContent = user.email;
                } else {
                    // User is signed out
                    signInBtn.innerHTML = 'Sign In';
                    signInBtn.onclick = () => document.getElementById('signInModal').classList.remove('hidden');
                }
                document.getElementById('signInModal').classList.add('hidden');
            }

            document.getElementById('closeUserPopup').addEventListener('click', function() {
                document.getElementById('userPopup').classList.add('hidden');
            });

            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('signInModal').classList.add('hidden');
            });

            document.getElementById('signOutBtn').addEventListener('click', function() {
                firebase.auth().signOut().then(() => {
                    updateUIForSignedInUser(null);
                    document.getElementById('userPopup').classList.add('hidden');
                    userBuoys = []
                });
            });

            // Close the modal if clicking outside of it
            window.onclick = function(event) {
                var modal = document.getElementById('signInModal');
                if (event.target == modal) {
                    modal.classList.add('hidden');
                }
            }

            // Check auth state on page load
            // Initialize MapLibre map
            var map = new maplibregl.Map({
                container: 'map',
                center: [-121.157227, 33.800832], // Note: MapLibre uses [lng, lat] order
                style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
                zoom: 5
            });

            // A helper function to add the contours source/layer
            function addContoursLayer() {
                if (map.getLayer('contour-fills')) {
                    map.removeLayer('contour-fills');
                }
                if (map.getSource('contours')) {
                    map.removeSource('contours');
                }
                map.addSource('contours', {
                    type: 'geojson',
                    data: '/static/contours_000.geojson'
                });

                // Add layer
                map.addLayer(
                    {
                    id: 'contour-fills',
                    type: 'fill',
                    source: 'contours',
                    paint: {
                        'fill-color': [
                        'case',
                        ['==', ['get', 'contour_level'], 2.0],  '#4575B4',
                        ['==', ['get', 'contour_level'], 4.0],  '#74ADD1',
                        ['==', ['get', 'contour_level'], 6.0],  '#F46D43',
                        ['==', ['get', 'contour_level'], 8.0],  '#D73027',
                        ['==', ['get', 'contour_level'], 10.0], '#A50026', '#ADD8E6' ], 'fill-opacity': 0.8
                        }
                    }
                );
            }

            map.on('style.load', () => {
                addContoursLayer();
                console.log("layers:" , map.getStyle().layers)
                map.moveLayer('contour-fills');
            });

            let isPlaying = false;
            let animationInterval;
            let forecastStartTime;

            // Fetch metadata and initialize time display
            async function fetchMetadata() {
                try {
                    const response = await fetch('/static/metadata.json');
                    if (!response.ok) {
                        throw new Error('Failed to fetch metadata');
                    }
                    const metadata = await response.json();
                    const timestamp = new Date(metadata.timestamp);
                    
                    // Parse the forecast_start format "20250104_00Z"
                    const [datePart, timePart] = metadata.forecast_start.split('_');
                    const year = datePart.substring(0, 4);
                    const month = datePart.substring(4, 6);
                    const day = datePart.substring(6, 8);
                    const hour = timePart.substring(0, 2);
                    
                    forecastStartTime = new Date(Date.UTC(year, month - 1, day, hour));

                    document.getElementById('metadataTimestamp').textContent = timestamp.toLocaleString();
                    updateTimeDisplay(0); // Initialize time display
                } catch (error) {
                    console.error('Error fetching metadata:', error);
                    document.getElementById('metadataTimestamp').textContent = 'Unable to load timestamp';
                }
            }

            function updateTimeDisplay(hours) {
                if (!forecastStartTime) return;

                const currentTime = new Date(forecastStartTime.getTime() + hours * 60 * 60 * 1000);
                const timeStr = currentTime.toLocaleString(undefined, {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                document.getElementById('forecastTime').textContent = timeStr;
            }

            function getNextTimeStep(currentHour) {
                // After 120 hours (5 days), increment by 3 hours
                if (currentHour >= 120) {
                    return currentHour + 3;
                }
                // Before 120 hours, increment by 1 hour
                return currentHour + 1;
            }

            function updateMap(hours) {
                const padded = String(hours).padStart(3, '0');
                timeValue.textContent = `+${padded} hrs`;
                map.getSource('contours').setData(`/static/contours_${padded}.geojson`);
                updateTimeDisplay(hours);
            }

            const playButton = document.getElementById('playButton');
            const timeSlider = document.getElementById('timeSlider');

            playButton.addEventListener('click', () => {
                isPlaying = !isPlaying;
                playButton.innerHTML = isPlaying ? 
                    '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>' :
                    '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M8 5v14l11-7z"/></svg>';

                if (isPlaying) {
                    animationInterval = setInterval(() => {
                        let currentHour = parseInt(timeSlider.value);
                        let nextHour = getNextTimeStep(currentHour);
                        
                        if (nextHour > 384) {
                            nextHour = 0;
                        }
                        
                        timeSlider.value = nextHour;
                        updateMap(nextHour);
                    }, 500); // Update every 500ms
                } else {
                    clearInterval(animationInterval);
                }
            });

            timeSlider.addEventListener('input', (event) => {
                const val = parseInt(event.target.value);
                updateMap(val);
                if (isPlaying) {
                    clearInterval(animationInterval);
                    isPlaying = false;
                    playButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M8 5v14l11-7z"/></svg>';
                }
            });



            async function getBuoyReport(buoyId, buoyName) {
                try {
                    const summaryResponse = await fetch(`/report_small/${buoyId}`);

                    if (!summaryResponse.ok) {
                        console.log("Error: Could not find buoy report");
                        throw new Error('Failed to load report');
                    }

                    const html = await summaryResponse.text();
                    document.getElementById('report-content').innerHTML = html;
                    window.initializeSwellDirection();

                    // console.log(buoyName);
                    document.getElementById('report-title').textContent = buoyName;

                } catch (error) {
                    console.error('Error loading report summary:', error);
                }
            }


            async function addBuoyToFavorites(stationId) {
                const user = firebase.auth().currentUser;
                if (!user) {
                    alert('Please sign in to add favorites');
                    return;
                }
                const uid = user.uid;
                try {
                    const response = await fetch(`/add?uid=${uid}&buoyid=${stationId}`);
                    if (!response.ok) {
                        throw new Error('Failed to add buoy to favorites');
                    }
                    alert('Buoy added to favorites');
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to add buoy to favorites');
                }
            }


            // Function to update favorite button appearance
            function updateFavoriteButton(button) {
                const stationId = button.dataset.stationId;
                const isFavorite = userBuoys.includes(stationId);
                button.textContent = isFavorite ? '-' : '+';
                button.className = `favorite-btn text-black font-bold py-1 px-2 text-sm w-8 flex items-center justify-center ${
                    isFavorite ? 'bg-red-100 hover:bg-red-200' : 'bg-green-100 hover:bg-green-200'
                }`;
            }

            // Create a MutationObserver to watch for new buttons
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1) { // ELEMENT_NODE
                            const favButtons = node.getElementsByClassName('favorite-btn');
                            Array.from(favButtons).forEach(updateFavoriteButton);
                        }
                    });
                });
            });

            // Start observing the document with the configured parameters
            observer.observe(document.body, { childList: true, subtree: true });

            function createPopupContent(buoy) {
                return `
                <div class="w-[220px]">
                <div class="text-md mb-2 break-words w-[220px]" style="word-wrap: break-word; overflow-wrap: break-word;">
                <span class="inline-block break-words">${buoy.name}</span>
                </div>
                <div class="flex gap-1">
                <button
            onclick="getBuoyReport('${buoy.stationId}', '${buoy.name}')"
            class="bg-gray-200 hover:bg-blue-200 text-black font-bold py-1 px-2 text-sm"
                >
                Report
                </button>
                <button
            onclick="window.location.href='/forecast/${buoy.stationId}'"
            class="bg-gray-200 hover:bg-blue-200 text-black font-bold py-1 px-2 text-sm"
                >
                Forecast
                </button>
                <button
            id="fav-${buoy.stationId}"
            onclick="toggleFavorite('${buoy.stationId}')"
            data-station-id="${buoy.stationId}"
            class="favorite-btn text-black font-bold py-1 px-2 text-sm w-8 flex items-center justify-center"
            >
            </button>
                </div>
                </div>`;
            }

            async function plotBuoys() {
                buoyData.forEach(buoy => {
                    // Create a DOM element for the marker
                    const el = document.createElement('div');
                    el.className = 'marker';
                    el.id = `buoymarker-${buoy.stationId}`;
                    el.style.width = '25px';
                    el.style.height = '25px';
                    el.style.backgroundImage = 'url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMSAxMGMwIDctOSAxMy05IDEzcy05LTYtOS0xM2E5IDkgMCAwIDEgMTgtMHoiPjwvcGF0aD48Y2lyY2xlIGN4PSIxMiIgY3k9IjEwIiByPSIzIj48L2NpcmNsZT48L3N2Zz4=)';
                    el.style.backgroundSize = '100%';
                    el.style.cursor = 'pointer';

                    // Create the popup with unique ID
                    const popup = new maplibregl.Popup({ 
                        offset: 25
                    })
                    .setHTML(createPopupContent(buoy));


                    // Create the marker and store references
                    const marker = new maplibregl.Marker(el)
                        .setLngLat([buoy.longitude, buoy.latitude])
                        .setPopup(popup)
                        .addTo(map);

                    popupMap.set(buoy.stationId, marker);

                    // Store marker reference on the element
                    el._marker = marker;
                });
            }

            async function toggleFavorite(stationId) {
                console.log(`Toggling favorite for station ID: ${stationId}`);
                console.log("user buoys here: ", userBuoys);
                console.log("station id here: ", stationId);
                const user = firebase.auth().currentUser;
                if (!user) {
                    alert('Please sign in to manage favorites');
                    return;
                }
                const uid = user.uid;

                if (userBuoys && userBuoys.includes(stationId)) {
                    // Remove from favorites
                    try {
                        const response = await fetch(`/delete?uid=${uid}&buoyid=${stationId}`);
                        if (!response.ok) {
                            throw new Error('Failed to remove buoy from favorites');
                        }
                        userBuoys = userBuoys.filter(id => id !== stationId);
                        alert('Buoy removed from favorites');
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Failed to remove buoy from favorites');
                    }
                } else {
                    // Add to favorites
                    try {
                        const response = await fetch(`/add?uid=${uid}&buoyid=${stationId}`);
                        if (!response.ok) {
                            throw new Error('Failed to add buoy to favorites');
                        }
                        userBuoys.push(stationId);
                        alert('Buoy added to favorites');
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Failed to add buoy to favorites');
                    }
                }

                // Refresh the favorites display and update popup content
                await loadForecastSummary(uid);
            }


            // these are all the buoys that have "spectral" data
            let currentBuoy = {};
            const buoyData = [
                { stationId: '41002', name: 'SOUTH HATTERAS - 225 NM South of Cape Hatteras', latitude: 31.759, longitude: -74.936},
                { stationId: '41004', name: 'EDISTO - 41 NM Southeast of Charleston, SC', latitude: 32.502, longitude: -79.099},
                { stationId: '41008', name: 'GRAYS REEF - 40 NM Southeast of Savannah, GA', latitude: 31.4, longitude: -80.866},
                { stationId: '41009', name: 'CANAVERAL 20 NM East of Cape Canaveral, FL', latitude: 28.508, longitude: -80.185},
                { stationId: '41013', name: 'Frying Pan Shoals, NC', latitude: 33.441, longitude: -77.764},
                { stationId: '41025', name: 'Diamond Shoals, NC', latitude: 35.01, longitude: -75.454},
                { stationId: '41040', name: 'NORTH EQUATORIAL ONE- 470 NM East of Martinique', latitude: 14.541, longitude: -53.137},
                { stationId: '41043', name: 'NE PUERTO RICO - 170 NM NNE of San Juan, PR', latitude: 21.026, longitude: -64.793},
                { stationId: '41044', name: 'NE ST MARTIN - 330 NM NE St Martin Is', latitude: 21.582, longitude: -58.63},
                { stationId: '41046', name: 'EAST BAHAMAS - 335 NM East of San Salvador Is,  Bahamas ', latitude: 23.822, longitude: -68.393},
                { stationId: '41047', name: 'NE BAHAMAS - 350 NM ENE of Nassau, Bahamas', latitude: 27.465, longitude: -71.452},
                { stationId: '41049', name: 'SOUTH BERMUDA - 300 NM SSE of Bermuda', latitude: 27.545, longitude: -63.012},
                { stationId: '41052', name: 'South of St. John, VI', latitude: 18.249, longitude: -64.763},
                { stationId: '41053', name: 'San Juan, PR', latitude: 18.474, longitude: -66.099},
                { stationId: '41056', name: 'Vieques Island, PR', latitude: 18.261, longitude: -65.464},
                { stationId: '41065', name: 'Capers Nearshore Waves (CAP2WAVE)', latitude: 32.802, longitude: -79.619},
                { stationId: '41067', name: 'FRP2WAVE', latitude: 32.276, longitude: -80.406},
                { stationId: '41070', name: 'Ponce de Leon Inlet Waves (PNCWAVE)', latitude: 29.289, longitude: -80.803},
                { stationId: '41076', name: 'CHR60WAVE', latitude: 32.536, longitude: -79.659},
                { stationId: '41108', name: 'Wilmington Harbor, NC - (200)', latitude: 33.721, longitude: -78.016},
                { stationId: '41110', name: 'Masonboro Inlet, ILM2, NC (150)', latitude: 34.143, longitude: -77.716},
                { stationId: '41112', name: 'Offshore Fernandina Beach, FL (132)', latitude: 30.709, longitude: -81.292},
                { stationId: '41113', name: 'Cape Canaveral Nearshore, FL (143)', latitude: 28.4, longitude: -80.533},
                { stationId: '41114', name: 'Fort Pierce, FL (134)', latitude: 27.552, longitude: -80.216},
                { stationId: '41115', name: 'Rincon, Puerto Rico (181)', latitude: 18.376, longitude: -67.28},
                { stationId: '41117', name: 'St. Augustine, FL (194)', latitude: 30.0, longitude: -81.08},
                { stationId: '41120', name: 'Cape Hatteras East, NC (250)', latitude: 35.258, longitude: -75.285},
                { stationId: '41121', name: 'Arecibo, Puerto Rico (249)', latitude: 18.49, longitude: -66.701},
                { stationId: '41159', name: 'Onslow Bay Outer, NC (217)', latitude: 34.213, longitude: -76.949},
                { stationId: '42001', name: 'MID GULF - 180 nm South of Southwest Pass, LA', latitude: 25.926, longitude: -89.662},
                { stationId: '42002', name: 'WEST GULF - 207 NM East of Brownsville, TX', latitude: 26.055, longitude: -93.646},
                { stationId: '42012', name: 'ORANGE BEACH - 44 NM SE of Mobile, AL', latitude: 30.06, longitude: -87.548},
                { stationId: '42019', name: 'FREEPORT, TX - 60 NM South of Freeport, TX', latitude: 27.91, longitude: -95.345},
                { stationId: '42036', name: 'WEST TAMPA  - 112 NM WNW of Tampa, FL', latitude: 28.501, longitude: -84.508},
                { stationId: '42040', name: 'LUKE OFFSHORE TEST PLATFORM - 63 NM South of Dauphin Island, AL', latitude: 29.207, longitude: -88.237},
                { stationId: '42055', name: 'BAY OF CAMPECHE - 214 NM NE of Veracruz, MX', latitude: 22.14, longitude: -94.112},
                { stationId: '42056', name: ' Yucatan Basin - 120 NM ESE of Cozumel, MX', latitude: 19.82, longitude: -84.945},
                { stationId: '42057', name: 'Western Caribbean - 195 NM WSW of Negril, Jamaica', latitude: 16.973, longitude: -81.575},
                { stationId: '42058', name: 'Central Caribbean - 210 NM SSE of Kingston, Jamaica', latitude: 14.844, longitude: -75.061},
                { stationId: '42059', name: 'Eastern Caribbean Sea - 180 NM SSW of Ponce, PR', latitude: 15.3, longitude: -67.483},
                { stationId: '42060', name: 'Caribbean Valley - 63 NM WSW of Montserrat', latitude: 16.434, longitude: -63.329},
                { stationId: '42084', name: 'Southwest Pass Entrance W, LA (256)', latitude: 28.988, longitude: -89.649},
                { stationId: '42085', name: 'Southeast of Ponce, PR', latitude: 17.87, longitude: -66.537},
                { stationId: '42091', name: 'Trinity Shoal, LA (255)', latitude: 29.087, longitude: -92.506},
                { stationId: '42097', name: 'Pulley Ridge, FL (226)', latitude: 25.714, longitude: -83.65},
                { stationId: '42098', name: 'Egmont Channel Entrance, FL (214)', latitude: 27.59, longitude: -82.931},
                { stationId: '42099', name: 'Offshore St. Petersburg, FL (144)', latitude: 27.349, longitude: -84.275},
                { stationId: '44005', name: 'GULF OF MAINE - 78 NM East of Portsmouth, NH', latitude: 43.201, longitude: -69.127},
                { stationId: '44007', name: 'PORTLAND - 12 NM Southeast of Portland,ME', latitude: 43.525, longitude: -70.14},
                { stationId: '44008', name: 'NANTUCKET 54 NM Southeast of Nantucket', latitude: 40.496, longitude: -69.25},
                { stationId: '44009', name: 'DELAWARE BAY 26 NM Southeast of Cape May, NJ', latitude: 38.46, longitude: -74.692},
                { stationId: '44013', name: 'BOSTON 16 NM East of Boston, MA', latitude: 42.346, longitude: -70.651},
                { stationId: '44014', name: 'VIRGINIA BEACH 64 NM East of Virginia Beach, VA', latitude: 36.603, longitude: -74.837},
                { stationId: '44018', name: 'CAPE COD - 9 NM North of Provincetown, MA', latitude: 42.203, longitude: -70.154},
                { stationId: '44020', name: 'NANTUCKET SOUND', latitude: 41.497, longitude: -70.283},
                { stationId: '44027', name: 'Jonesport, ME - 20 NM SE of Jonesport, ME', latitude: 44.283, longitude: -67.3},
                { stationId: '44056', name: 'Duck FRF, NC', latitude: 36.2, longitude: -75.714},
                { stationId: '44065', name: 'New York Harbor Entrance - 15 NM SE of Breezy Point , NY', latitude: 40.369, longitude: -73.703},
                { stationId: '44078', name: 'OOI Irminger Sea Surface Mooring', latitude: 59.94, longitude: -39.52},
                { stationId: '44084', name: 'Bethany Beach, DE (263)', latitude: 38.537, longitude: -75.044},
                { stationId: '44085', name: 'Buzzards Bay, MA (260)', latitude: 41.387, longitude: -71.032},
                { stationId: '44086', name: 'Nags Head, NC (243)', latitude: 36.001, longitude: -75.421},
                { stationId: '44087', name: 'Thimble Shoal, VA (240)', latitude: 37.026, longitude: -76.149},
                { stationId: '44088', name: 'Virginia Beach Offshore, VA (171)', latitude: 36.614, longitude: -74.841},
                { stationId: '44089', name: 'Wallops Island, VA (224)', latitude: 37.754, longitude: -75.325},
                { stationId: '44090', name: 'Cape Cod Bay, MA (221)', latitude: 41.84, longitude: -70.329},
                { stationId: '44091', name: 'Barnegat, NJ (209)', latitude: 39.768, longitude: -73.77},
                { stationId: '44095', name: 'Oregon Inlet, NC (192)', latitude: 35.75, longitude: -75.33},
                { stationId: '44097', name: 'Block Island, RI  (154)', latitude: 40.967, longitude: -71.124},
                { stationId: '44098', name: 'Jeffreys Ledge, NH (160)', latitude: 42.8, longitude: -70.171},
                { stationId: '44099', name: 'Cape Henry, VA (147)', latitude: 36.915, longitude: -75.722},
                { stationId: '44100', name: 'Duck FRF 26m, NC (430)', latitude: 36.258, longitude: -75.593},
                { stationId: '45161', name: 'Muskegon Buoy, MI', latitude: 43.185, longitude: -86.352},
                { stationId: '45212', name: 'North Huron Spotter', latitude: 45.351, longitude: -82.84},
                { stationId: '45213', name: 'East Superior Spotter', latitude: 47.585, longitude: -86.585},
                { stationId: '45214', name: 'South Michigan Spotter', latitude: 42.674, longitude: -87.026},
                { stationId: '46001', name: 'WESTERN GULF OF ALASKA  - 175NM SE of Kodiak, AK', latitude: 56.3, longitude: -148.018},
                { stationId: '46005', name: 'WEST WASHINGTON - 300NM West of Aberdeen, WA', latitude: 46.143, longitude: -131.09},
                { stationId: '46006', name: 'SOUTHEAST PAPA - 600NM West of Eureka, CA', latitude: 40.764, longitude: -137.377},
                { stationId: '46011', name: 'SANTA MARIA - 21NM NW of Point Arguello, CA', latitude: 34.936, longitude: -120.998},
                { stationId: '46013', name: 'BODEGA BAY - 48NM NW of San Francisco, CA', latitude: 38.235, longitude: -123.317},
                { stationId: '46014', name: 'PT ARENA - 19NM North of Point Arena, CA', latitude: 39.225, longitude: -123.98},
                { stationId: '46022', name: 'EEL RIVER - 17NM WSW of Eureka, CA', latitude: 40.716, longitude: -124.54},
                { stationId: '46025', name: 'Santa Monica Basin - 33NM WSW of Santa Monica, CA', latitude: 33.755, longitude: -119.045},
                { stationId: '46026', name: 'SAN FRANCISCO - 18NM West of San Francisco, CA', latitude: 37.754, longitude: -122.839},
                { stationId: '46027', name: 'ST GEORGES - 8 NM NW of Crescent City, CA', latitude: 41.84, longitude: -124.382},
                { stationId: '46028', name: 'CAPE SAN MARTIN - 55NM West NW of Morro Bay, CA', latitude: 35.77, longitude: -121.903},
                { stationId: '46041', name: 'CAPE ELIZABETH - 45NM NW of Aberdeen, WA', latitude: 47.352, longitude: -124.739},
                { stationId: '46047', name: 'TANNER BANK - 121 NM West of San Diego, CA', latitude: 32.388, longitude: -119.525},
                { stationId: '46050', name: 'STONEWALL BANK - 20NM West of Newport, OR', latitude: 44.669, longitude: -124.546},
                { stationId: '46053', name: 'EAST SANTA BARBARA  - 12NM Southwest of Santa Barbara, CA', latitude: 34.241, longitude: -119.839},
                { stationId: '46054', name: 'WEST SANTA BARBARA  38 NM West of Santa Barbara, CA', latitude: 34.274, longitude: -120.468},
                { stationId: '46059', name: 'WEST CALIFORNIA - 357NM West of San Francisco, CA', latitude: 38.069, longitude: -129.976},
                { stationId: '46060', name: 'WEST ORCA BAY - 8NM NW of Hinchinbrook Is., AK', latitude: 60.571, longitude: -146.795},
                { stationId: '46066', name: 'SOUTH KODIAK - 310NM SSW of Kodiak, AK', latitude: 52.765, longitude: -155.009},
                { stationId: '46069', name: 'SOUTH SANTA ROSA - 14 NM SW of Santa Rosa Island, CA', latitude: 33.677, longitude: -120.213},
                { stationId: '46070', name: 'SOUTHWEST BERING SEA - 142NM NNE OF ATTU IS, AK', latitude: 55.065, longitude: 175.268},
                { stationId: '46071', name: 'WESTERN ALEUTIANS - 14NM SOUTH OF AMCHITKA IS, AK ', latitude: 51.022, longitude: 179.784},
                { stationId: '46072', name: 'CENTRAL ALEUTIANS 230 NM SW Dutch Harbor', latitude: 51.666, longitude: -172.114},
                { stationId: '46075', name: 'SHUMAGIN ISLANDS - 85NM South of Sand Point, AK', latitude: 53.969, longitude: -160.794},
                { stationId: '46076', name: 'CAPE CLEARE - 17 NM South of Montague Is,  AK', latitude: 59.471, longitude: -148.009},
                { stationId: '46077', name: 'SHELIKOF STRAIT, AK', latitude: 57.869, longitude: -154.211},
                { stationId: '46078', name: 'ALBATROSS BANK - 104NM South of Kodiak Is., AK', latitude: 55.561, longitude: -152.599},
                { stationId: '46080', name: 'PORTLOCK BANK - 76 NM ENE of Kodiak, AK', latitude: 57.916, longitude: -150.133},
                { stationId: '46081', name: 'Western Prince William Sound', latitude: 60.802, longitude: -148.283},
                { stationId: '46082', name: 'Cape Suckling - 35 NM SE of Kayak Is, AK', latitude: 59.67, longitude: -143.353},
                { stationId: '46083', name: 'FAIRWEATHER GROUND - 105 NM West  of Juneau, AK', latitude: 58.27, longitude: -138.019},
                { stationId: '46084', name: 'CAPE EDGECUMBE - 25NM SSW of Cape Edgecumbe, AK', latitude: 56.614, longitude: -136.04},
                { stationId: '46086', name: 'SAN CLEMENTE BASIN - 27NM SE Of San Clemente Is, CA', latitude: 32.499, longitude: -118.052},
                { stationId: '46088', name: 'NEW DUNGENESS - 17 NM NE of Port Angeles, WA', latitude: 48.332, longitude: -123.179},
                { stationId: '46097', name: 'OOI Newport Shelf', latitude: 44.639, longitude: -124.304},
                { stationId: '46098', name: 'OOI Waldport Offshore', latitude: 44.378, longitude: -124.947},
                { stationId: '46099', name: 'OOI Westport Shelf', latitude: 46.988, longitude: -124.567},
                { stationId: '46100', name: 'OOI Westport Offshore', latitude: 46.851, longitude: -124.964},
                { stationId: '46108', name: 'Lower Cook Inlet (204)', latitude: 59.598, longitude: -151.828},
                { stationId: '46211', name: 'Grays Harbor, WA (036)', latitude: 46.857, longitude: -124.244},
                { stationId: '46213', name: 'Cape Mendocino, CA (094)', latitude: 40.295, longitude: -124.732},
                { stationId: '46214', name: 'Point Reyes, CA (029)', latitude: 37.937, longitude: -123.463},
                { stationId: '46215', name: 'Diablo Canyon, CA (076)', latitude: 35.204, longitude: -120.859},
                { stationId: '46218', name: 'Harvest, CA (071)', latitude: 34.452, longitude: -120.78},
                { stationId: '46219', name: 'San Nicolas Island, CA (067)', latitude: 33.219, longitude: -119.872},
                { stationId: '46221', name: 'Santa Monica Bay, CA (028)', latitude: 33.86, longitude: -118.641},
                { stationId: '46222', name: 'San Pedro, CA (092)', latitude: 33.618, longitude: -118.317},
                { stationId: '46224', name: 'Oceanside Offshore, CA (045)', latitude: 33.178, longitude: -117.472},
                { stationId: '46225', name: 'Torrey Pines Outer, CA (100)', latitude: 32.933, longitude: -117.391},
                { stationId: '46229', name: 'UMPQUA OFFSHORE, OR (139)', latitude: 43.772, longitude: -124.549},
                { stationId: '46232', name: 'Point Loma South, CA  (191)', latitude: 32.517, longitude: -117.425},
                { stationId: '46235', name: 'Imperial Beach Nearshore, CA (155)', latitude: 32.57, longitude: -117.169},
                { stationId: '46237', name: 'San Francisco Bar, CA  (142)', latitude: 37.788, longitude: -122.634},
                { stationId: '46239', name: 'Point Sur, CA (157)', latitude: 36.335, longitude: -122.104},
                { stationId: '46240', name: 'Cabrillo Point, Monterey Bay, CA  (158)', latitude: 36.626, longitude: -121.907},
                { stationId: '46243', name: 'Clatsop Spit, OR (162)', latitude: 46.216, longitude: -124.128},
                { stationId: '46244', name: 'Humboldt Bay, North Spit, CA (168)', latitude: 40.896, longitude: -124.357},
                { stationId: '46251', name: 'Santa Cruz Basin, CA (203)', latitude: 33.769, longitude: -119.565},
                { stationId: '46253', name: 'San Pedro South, CA (213)', latitude: 33.576, longitude: -118.181},
                { stationId: '46254', name: 'SCRIPPS Nearshore, CA (201)', latitude: 32.868, longitude: -117.267},
                { stationId: '46256', name: 'Long Beach Channel, CA (215)', latitude: 33.7, longitude: -118.201},
                { stationId: '46258', name: 'Mission Bay West, CA (220)', latitude: 32.749, longitude: -117.502},
                { stationId: '46259', name: 'Santa Lucia Escarpment, CA (222)', latitude: 34.767, longitude: -121.498},
                { stationId: '46266', name: 'Del Mar Nearshore, CA (153)', latitude: 32.957, longitude: -117.279},
                { stationId: '46267', name: 'Angeles Point, WA (248)', latitude: 48.173, longitude: -123.607},
                { stationId: '46268', name: 'Topanga Nearshore, CA (103)', latitude: 34.022, longitude: -118.578},
                { stationId: '46274', name: 'Leucadia Nearshore, CA (262)', latitude: 33.062, longitude: -117.314},
                { stationId: '46275', name: 'Red Beach Nearshore, CA (264)', latitude: 33.29, longitude: -117.5},
                { stationId: '46276', name: 'Pajaro Beach, CA (266)', latitude: 36.845, longitude: -121.825},
                { stationId: '46277', name: 'Green Beach Offshore, CA (271)', latitude: 33.336, longitude: -117.659},
                { stationId: '46278', name: 'Tillamook Bay South Jetty, OR (270)', latitude: 45.561, longitude: -123.991},
                { stationId: '46279', name: 'Pajaro Beach South, CA (267)', latitude: 36.838, longitude: -121.82},
                { stationId: '51000', name: 'NORTHERN HAWAII ONE - 245NM NE of Honolulu HI', latitude: 23.528, longitude: -153.792},
                { stationId: '51001', name: 'NORTHWESTERN HAWAII ONE - 188 NM NW of Kauai Island, HI', latitude: 24.451, longitude: -162.008},
                { stationId: '51003', name: 'WESTERN  HAWAII - 205 NM SW of Honolulu, HI', latitude: 19.196, longitude: -160.639},
                { stationId: '51004', name: 'SOUTHEAST HAWAII - 205 NM Southeast of Hilo, HI', latitude: 17.538, longitude: -152.23},
                { stationId: '51101', name: 'NORTHWESTERN HAWAII TWO - 186 NM NW of Kauai Is., HI   ', latitude: 24.359, longitude: -162.081},
                { stationId: '51201', name: 'Waimea Bay, HI (106)', latitude: 21.671, longitude: -158.118},
                { stationId: '51202', name: 'Mokapu Point, HI (098)', latitude: 21.417, longitude: -157.68},
                { stationId: '51205', name: 'Pauwela, Maui, HI (187)', latitude: 21.018, longitude: -156.425},
                { stationId: '51207', name: 'Kaneohe Bay, HI (198)', latitude: 21.477, longitude: -157.752},
                { stationId: '51210', name: 'Kaneohe Bay, WETS, HI (225)', latitude: 21.477, longitude: -157.757},
                { stationId: '51211', name: 'Pearl Harbor Entrance, HI (233)', latitude: 21.297, longitude: -157.959},
                { stationId: '51212', name: 'Barbers Point, Kalaeloa, HI (238)', latitude: 21.323, longitude: -158.149},
                { stationId: '52200', name: 'Ipan, Guam (121)', latitude: 13.354, longitude: 144.788},
                { stationId: '52201', name: 'Kalo, Majuro, Marshall Islands (163)', latitude: 7.079, longitude: 171.384},
                { stationId: '52211', name: 'Tanapag, Saipan, NMI (197)', latitude: 15.268, longitude: 145.662},
                { stationId: '52212', name: 'Ngaraard, Babeldaob, Palau (219)', latitude: 7.63, longitude: 134.671},
                { stationId: '62107', name: 'Sevenstones Lightship', latitude: 50.102, longitude: -6.1},
                { stationId: '62127', name: 'Cleeton AWS', latitude: 54.0, longitude: 0.7},
                { stationId: '62130', name: 'Brae A', latitude: 58.7, longitude: 1.3},
                { stationId: '62144', name: 'Clipper AWS', latitude: 53.4, longitude: 1.7},
                { stationId: '62145', name: 'North Sea', latitude: 53.102, longitude: 2.8},
                { stationId: '62146', name: 'Lomond AWS', latitude: 57.2, longitude: 2.1},
                { stationId: '62149', name: 'West Sole "A" AWS', latitude: 53.7, longitude: 1.1},
                { stationId: '62165', name: 'Ravenspurn North AWS', latitude: 54.0, longitude: 1.1},
                { stationId: '62170', name: 'F3 Light Vessel', latitude: 51.24, longitude: 2.0},
                { stationId: '62304', name: 'Sandettie Lightship', latitude: 51.102, longitude: 1.8},
                { stationId: '62305', name: 'Greenwich Lightship', latitude: 50.4, longitude: 0.0},
                { stationId: '63110', name: 'Beryl A AWS', latitude: 59.5, longitude: 1.5},
                { stationId: '63112', name: 'Cormorant AWS', latitude: 61.1, longitude: 1.0},
                { stationId: '63115', name: 'Magnus AWS', latitude: 61.6, longitude: 1.3},
            ];

            document.getElementById('search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                let matches = buoyData.filter(buoy => buoy.name.toLowerCase().includes(searchTerm));
                displayMatches(matches);
            });



            function displayMatches(matches) {
                const searchResults = document.getElementById('searchResults');
                searchResults.innerHTML = ''; // Clear previous results

                matches.forEach(match => {
                    const div = document.createElement('div');
                    div.classList.add('p-1', 'border-b', 'border-gray-200', 'dark:border-gray-700', 'cursor-pointer', 'hover:bg-gray-100', 'dark:hover:bg-slate-700', 'dark:bg-slate-800');
                    div.textContent = match.name;
                    div.onclick = function () {
                        getBuoyReport(match.stationId, match.name);
                        searchResults.innerHTML = ''; 
                        currentBuoy = match;

                        console.log(`Jumping to buoy: ${match.stationId}`);

                        // Retrieve the marker from markerMap
                        const marker = popupMap.get(match.stationId);
                        console.log(marker)

                        if (marker) {
                            // Trigger the popup
                            marker.togglePopup();

                            // Center the map on the marker with an offset
                            map.flyTo({
                                center: [match.longitude, match.latitude],
                                zoom: 4,
                                offset: [0, -100], // Offset to account for the popup
                            });
                        } else {
                            console.warn(`No marker found for stationId: ${match.stationId}`);
                        }
                    };
                    searchResults.appendChild(div);
                });
            }



            // Clicking outside the search results hides them
            window.addEventListener('click', function(e) {
            const searchResults = document.getElementById('searchResults');
            if (!document.getElementById('search').contains(e.target)) {
            searchResults.innerHTML = '';
            }
            });

            document.getElementById('forecastBtn').addEventListener('click', function() {
            if (currentBuoy.stationId === undefined) {
            alert('Please select a buoy first');
            return;
            }
            window.location.href = `/forecast/${currentBuoy.stationId}`;
            });


            function toggleDarkMode() {
                const isDark = document.documentElement.classList.contains('dark');
                if (isDark) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('darkMode', 'false');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('darkMode', 'true');
                }
            }

            // Set initial dark mode state
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
            }  
            

            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

            //center the map
            map.setCenter([-119.069824, 33.101608]);
            map.setZoom(3);

            plotBuoys();
        
            // Fetch metadata when page loads
            fetchMetadata();
        </script>


</html>
